name: Merge Data

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: "Workflow run ID to download partition artifacts from"
        required: true
        type: string

concurrency:
  group: merge-data
  cancel-in-progress: false

env:
  RUST_LOG: crime_map=debug

jobs:
  merge:
    name: Merge Artifacts
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pipeline tools
        uses: ./.github/actions/setup-pipeline
        with:
          rust-cache-key: merge

      - name: Download boundary artifacts
        uses: actions/download-artifact@v4
        with:
          name: boundaries
          path: data/boundaries
          run-id: ${{ inputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download all partition artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: partition-*
          path: data/partitions
          run-id: ${{ inputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: List downloaded artifacts
        run: |
          echo "=== Boundaries ==="
          ls -lah data/boundaries/ 2>/dev/null || echo "none"
          echo "=== Partitions ==="
          find data/partitions -type f | head -100

      - name: Merge artifacts
        run: |
          PARTITION_DIRS=$(find data/partitions -mindepth 1 -maxdepth 1 -type d | sort | tr '\n' ',' | sed 's/,$//')
          echo "Merging partition dirs: $PARTITION_DIRS"

          mkdir -p data/generated
          cargo generate merge \
            --partition-dirs "$PARTITION_DIRS" \
            --boundaries-dir data/boundaries \
            --output-dir data/generated

      - name: List merged files
        run: ls -lah data/generated/

      - name: Upload merged artifacts
        uses: actions/upload-artifact@v4
        with:
          name: merged-data
          path: data/generated/
          retention-days: 14
