name: Merge Data

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: "Workflow run ID to download partition artifacts from (uses GitHub artifacts)"
        required: false
        type: string
      from_r2:
        description: "Pull partition outputs from R2 instead of GitHub artifacts"
        required: false
        type: boolean
        default: false

concurrency:
  group: merge-data
  cancel-in-progress: false

env:
  RUST_LOG: crime_map=debug
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
  R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
  R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}

jobs:
  build:
    name: Build Binaries
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pipeline tools (with Rust)
        uses: ./.github/actions/setup-pipeline
        with:
          install-rust: 'true'
          rust-cache-key: merge-build

      - name: Build release binaries
        run: cargo build --release -p crime_map_generate -p crime_map_ingest

      - name: Stage binaries for upload
        run: |
          mkdir -p staging
          cp target/release/crime_map_generate staging/
          cp target/release/crime_map_ingest staging/

      - name: Upload pipeline binaries
        uses: actions/upload-artifact@v4
        with:
          name: pipeline-binaries
          path: staging/
          retention-days: 1

  merge:
    name: Merge Artifacts
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pipeline tools (no Rust)
        uses: ./.github/actions/setup-pipeline
        with:
          install-rust: 'false'

      - name: Download pipeline binaries
        uses: actions/download-artifact@v4
        with:
          name: pipeline-binaries
          path: /usr/local/bin

      - name: Make binaries executable
        run: chmod +x /usr/local/bin/crime_map_generate /usr/local/bin/crime_map_ingest

      # ── From R2 path ─────────────────────────────────────────────────
      - name: Pull boundary outputs from R2
        if: ${{ inputs.from_r2 }}
        run: |
          mkdir -p data/boundaries
          crime_map_ingest pull-generated-boundaries --dir data/boundaries

      - name: Pull partition outputs from R2
        if: ${{ inputs.from_r2 }}
        run: |
          PARTITIONS=$(crime_map_ingest list-generated-partitions 2>/dev/null | grep "^  " | tr -d ' ')
          for name in $PARTITIONS; do
            mkdir -p "data/partitions/$name"
            crime_map_ingest pull-generated-partition --name "$name" --dir "data/partitions/$name"
          done

      # ── From GitHub artifacts path ───────────────────────────────────
      - name: Download boundary artifacts
        if: ${{ !inputs.from_r2 }}
        uses: actions/download-artifact@v4
        with:
          name: boundaries
          path: data/boundaries
          run-id: ${{ inputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download all partition artifacts
        if: ${{ !inputs.from_r2 }}
        uses: actions/download-artifact@v4
        with:
          pattern: partition-*
          path: data/partitions
          run-id: ${{ inputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      # ── Merge (both paths) ──────────────────────────────────────────
      - name: List downloaded artifacts
        run: |
          echo "=== Boundaries ==="
          ls -lah data/boundaries/ 2>/dev/null || echo "none"
          echo "=== Partitions ==="
          find data/partitions -type f | head -100

      - name: Merge artifacts
        run: |
          PARTITION_DIRS=$(find data/partitions -mindepth 1 -maxdepth 1 -type d | sort | tr '\n' ',' | sed 's/,$//')
          echo "Merging partition dirs: $PARTITION_DIRS"

          mkdir -p data/generated
          crime_map_generate merge \
            --partition-dirs "$PARTITION_DIRS" \
            --boundaries-dir data/boundaries \
            --output-dir data/generated

      - name: List merged files
        run: ls -lah data/generated/

      # Push merged outputs to R2
      - name: Push merged outputs to R2
        run: crime_map_ingest push-generated-merged --dir data/generated
