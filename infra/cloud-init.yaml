#cloud-config

package_update: true
package_upgrade: true

packages:
  - ca-certificates
  - curl
  - gnupg
  - jq
  - unzip

write_files:
  # Docker daemon config for data directory on large volume
  - path: /etc/docker/daemon.json
    content: |
      {
        "data-root": "/data/docker",
        "log-driver": "json-file",
        "log-opts": {
          "max-size": "10m",
          "max-file": "3"
        }
      }
    permissions: "0644"

  # Pelias config
  - path: /data/pelias/pelias.json
    content: |
      {
        "logger": { "level": "info" },
        "esclient": {
          "apiVersion": "7.x",
          "hosts": [
            { "host": "elasticsearch" }
          ]
        },
        "elasticsearch": {
          "settings": {
            "index": {
              "number_of_replicas": "0",
              "number_of_shards": "1",
              "refresh_interval": "10s"
            }
          }
        },
        "acceptance-tests": { "endpoints": { "local": "http://api:4000/v1/" } },
        "api": {
          "services": {
            "pip": { "url": "http://pip:4200" },
            "placeholder": { "url": "http://placeholder:4100" }
          },
          "defaultParameters": {
            "boundary.country": "USA"
          }
        },
        "imports": {
          "adminLookup": { "enabled": true },
          "openstreetmap": {
            "download": [
              {
                "sourceURL": "https://download.geofabrik.de/north-america/us-latest.osm.pbf"
              }
            ],
            "leveldbpath": "/tmp/leveldb",
            "importVenues": true,
            "importAddresses": true
          },
          "openaddresses": {
            "files": [
              "us/nationwide/openaddresses-us_nationwide.csv"
            ]
          },
          "polylines": {
            "files": [ "extract.0sv" ]
          },
          "whosonfirst": {
            "importVenues": false,
            "countryCode": ["US"],
            "datapath": "/data/whosonfirst"
          },
          "interpolation": {
            "download": {
              "tiger": {
                "datapath": "/data/tiger",
                "states": [
                  { "state_code": "01", "county_code": null },
                  { "state_code": "02", "county_code": null },
                  { "state_code": "04", "county_code": null },
                  { "state_code": "05", "county_code": null },
                  { "state_code": "06", "county_code": null },
                  { "state_code": "08", "county_code": null },
                  { "state_code": "09", "county_code": null },
                  { "state_code": "10", "county_code": null },
                  { "state_code": "11", "county_code": null },
                  { "state_code": "12", "county_code": null },
                  { "state_code": "13", "county_code": null },
                  { "state_code": "15", "county_code": null },
                  { "state_code": "16", "county_code": null },
                  { "state_code": "17", "county_code": null },
                  { "state_code": "18", "county_code": null },
                  { "state_code": "19", "county_code": null },
                  { "state_code": "20", "county_code": null },
                  { "state_code": "21", "county_code": null },
                  { "state_code": "22", "county_code": null },
                  { "state_code": "23", "county_code": null },
                  { "state_code": "24", "county_code": null },
                  { "state_code": "25", "county_code": null },
                  { "state_code": "26", "county_code": null },
                  { "state_code": "27", "county_code": null },
                  { "state_code": "28", "county_code": null },
                  { "state_code": "29", "county_code": null },
                  { "state_code": "30", "county_code": null },
                  { "state_code": "31", "county_code": null },
                  { "state_code": "32", "county_code": null },
                  { "state_code": "33", "county_code": null },
                  { "state_code": "34", "county_code": null },
                  { "state_code": "35", "county_code": null },
                  { "state_code": "36", "county_code": null },
                  { "state_code": "37", "county_code": null },
                  { "state_code": "38", "county_code": null },
                  { "state_code": "39", "county_code": null },
                  { "state_code": "40", "county_code": null },
                  { "state_code": "41", "county_code": null },
                  { "state_code": "42", "county_code": null },
                  { "state_code": "44", "county_code": null },
                  { "state_code": "45", "county_code": null },
                  { "state_code": "46", "county_code": null },
                  { "state_code": "47", "county_code": null },
                  { "state_code": "48", "county_code": null },
                  { "state_code": "49", "county_code": null },
                  { "state_code": "50", "county_code": null },
                  { "state_code": "51", "county_code": null },
                  { "state_code": "53", "county_code": null },
                  { "state_code": "54", "county_code": null },
                  { "state_code": "55", "county_code": null },
                  { "state_code": "56", "county_code": null }
                ]
              }
            }
          }
        }
      }
    permissions: "0644"

  # Docker Compose for Pelias stack
  - path: /data/pelias/docker-compose.yml
    content: |
      services:
        api:
          image: pelias/api:latest
          container_name: pelias_api
          restart: unless-stopped
          ports:
            - "4000:4000"
          environment:
            - PORT=4000
          volumes:
            - ./pelias.json:/code/pelias.json:ro

        placeholder:
          image: pelias/placeholder:latest
          container_name: pelias_placeholder
          restart: unless-stopped
          environment:
            - PORT=4100
          volumes:
            - ./pelias.json:/code/pelias.json:ro
            - placeholder-data:/data/placeholder

        pip:
          image: pelias/pip-service:latest
          container_name: pelias_pip
          restart: unless-stopped
          environment:
            - PORT=4200
          volumes:
            - ./pelias.json:/code/pelias.json:ro
            - whosonfirst-data:/data/whosonfirst

        elasticsearch:
          image: pelias/elasticsearch:7.17.1
          container_name: pelias_elasticsearch
          restart: unless-stopped
          ulimits:
            memlock:
              soft: -1
              hard: -1
            nofile:
              soft: 65536
              hard: 65536
          environment:
            - "ES_JAVA_OPTS=-Xms4g -Xmx4g"
            - "discovery.type=single-node"
            - "bootstrap.memory_lock=true"
          volumes:
            - elasticsearch-data:/usr/share/elasticsearch/data

      volumes:
        elasticsearch-data:
          driver: local
          driver_opts:
            type: none
            o: bind
            device: /data/pelias/elasticsearch
        placeholder-data:
          driver: local
          driver_opts:
            type: none
            o: bind
            device: /data/pelias/placeholder
        whosonfirst-data:
          driver: local
          driver_opts:
            type: none
            o: bind
            device: /data/pelias/whosonfirst
    permissions: "0644"

  # Pelias data import script
  - path: /data/pelias/import.sh
    content: |
      #!/bin/bash
      set -euo pipefail

      PELIAS_DIR="/data/pelias"
      cd "$PELIAS_DIR"

      echo "=== Pelias Data Import ==="
      echo "This will download and import US geocoding data."
      echo "Expected disk usage: ~80-100 GB"
      echo "Expected time: 6-12 hours depending on network speed"
      echo ""

      # Create data directories
      mkdir -p elasticsearch placeholder whosonfirst

      # Set Elasticsearch memory map limit
      sysctl -w vm.max_map_count=262144

      # Start Elasticsearch first
      echo "[1/8] Starting Elasticsearch..."
      docker compose up -d elasticsearch
      echo "Waiting for Elasticsearch to be ready..."
      until curl -s http://localhost:9200/_cluster/health | jq -r '.status' | grep -qE 'yellow|green'; do
        sleep 5
        echo "  waiting..."
      done
      echo "Elasticsearch is ready."

      # Create Pelias schema
      echo "[2/8] Creating Pelias schema..."
      docker compose run --rm api node -e "
        const schema = require('pelias-schema');
        schema.create_index().then(() => console.log('Schema created'));
      " || {
        echo "Schema creation via API failed, trying dedicated schema container..."
        docker run --rm --network pelias_default \
          -v "$PELIAS_DIR/pelias.json:/code/pelias.json:ro" \
          pelias/schema:latest node scripts/create_index.js
      }

      # Download Who's On First data
      echo "[3/8] Downloading Who's On First data (US)..."
      docker run --rm \
        -v "$PELIAS_DIR/pelias.json:/code/pelias.json:ro" \
        -v "$PELIAS_DIR/whosonfirst:/data/whosonfirst" \
        pelias/whosonfirst:latest ./bin/download

      # Import Who's On First
      echo "[4/8] Importing Who's On First..."
      docker run --rm --network pelias_default \
        -v "$PELIAS_DIR/pelias.json:/code/pelias.json:ro" \
        -v "$PELIAS_DIR/whosonfirst:/data/whosonfirst" \
        pelias/whosonfirst:latest ./bin/start

      # Download and import OpenStreetMap
      echo "[5/8] Downloading OpenStreetMap US extract..."
      mkdir -p openstreetmap
      docker run --rm \
        -v "$PELIAS_DIR/pelias.json:/code/pelias.json:ro" \
        -v "$PELIAS_DIR/openstreetmap:/data/openstreetmap" \
        pelias/openstreetmap:latest ./bin/download

      echo "[6/8] Importing OpenStreetMap..."
      docker run --rm --network pelias_default \
        -v "$PELIAS_DIR/pelias.json:/code/pelias.json:ro" \
        -v "$PELIAS_DIR/openstreetmap:/data/openstreetmap" \
        pelias/openstreetmap:latest ./bin/start

      # Download and build placeholder
      echo "[7/8] Building Placeholder..."
      docker run --rm \
        -v "$PELIAS_DIR/pelias.json:/code/pelias.json:ro" \
        -v "$PELIAS_DIR/placeholder:/data/placeholder" \
        pelias/placeholder:latest ./cmd/download.sh
      docker run --rm \
        -v "$PELIAS_DIR/pelias.json:/code/pelias.json:ro" \
        -v "$PELIAS_DIR/placeholder:/data/placeholder" \
        pelias/placeholder:latest ./cmd/build.sh

      # Start all services
      echo "[8/8] Starting all Pelias services..."
      docker compose up -d

      echo ""
      echo "=== Import complete ==="
      echo "Pelias API: http://localhost:4000"
      echo "Test: curl 'http://localhost:4000/v1/search?text=1600+Pennsylvania+Ave+Washington+DC&size=1'"
    permissions: "0755"

  # Anti-idle cron to prevent OCI from reclaiming the instance
  - path: /etc/cron.d/anti-idle
    content: |
      # Prevent Oracle Cloud from reclaiming Always Free instances due to idle
      */5 * * * * root dd if=/dev/urandom of=/tmp/anti-idle bs=1 count=1 2>/dev/null; sync
    permissions: "0644"

  # Systemd service to set vm.max_map_count on boot (required by Elasticsearch)
  - path: /etc/sysctl.d/99-elasticsearch.conf
    content: |
      vm.max_map_count=262144
    permissions: "0644"

runcmd:
  # Install Docker (official method for Ubuntu ARM)
  - install -m 0755 -d /etc/apt/keyrings
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
  - chmod a+r /etc/apt/keyrings/docker.asc
  - echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo $VERSION_CODENAME) stable" > /etc/apt/sources.list.d/docker.list
  - apt-get update
  - apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
  - systemctl enable docker
  - systemctl start docker
  - usermod -aG docker ubuntu

  # Apply sysctl settings
  - sysctl --system

  # Create Pelias data directories
  - mkdir -p /data/pelias/elasticsearch
  - mkdir -p /data/pelias/placeholder
  - mkdir -p /data/pelias/whosonfirst
  - mkdir -p /data/pelias/openstreetmap
  - chown -R ubuntu:ubuntu /data/pelias

  # Set iptables rules for OCI (required for Docker port forwarding)
  - iptables -I INPUT 6 -m state --state NEW -p tcp --dport 4000 -j ACCEPT
  - iptables -I INPUT 6 -m state --state NEW -p tcp --dport 9200 -j ACCEPT
  - netfilter-persistent save

  # Log completion
  - echo "Cloud-init complete. Run 'sudo /data/pelias/import.sh' to start the Pelias data import."
